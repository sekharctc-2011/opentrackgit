<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My Electron Screenshot App</title>
        
    </head>
    <body>
        <p>Testing screenshots in Electron :3</p>
        <!-- <img id="my-preview"/> -->
        <label id="screenshot-path">Path :: </label>
        <input type="file" name="" value="upload file">
        <button id="screen-shot">Take Screenshot</button>
        <input type="text" name="" value="" id="scid">
        <button id="addimg">Add image</button><span></span>
        <!-- <canvas name="scimg" id="scimg" width="550" height="550"></canvas> -->

        <img id="my-preview"/>
        <input id="trigger" value="Fullscreen screenshot" type="button"/>
        <input type="text" id="base64_img" value="blah blah"/>


        
    </body>
    <script>
        
        let $ = require('jquery')
        require('./render.js')

        var remote = require('electron').remote;
        document.addEventListener('keydown', function (e){
            if (e.which === 123) {
                remote.getCurrentWindow().webContents.openDevTools();
            } else if (e.which === 116){
                location.reload();
            }
        });

$("#addimg").click(testdd);
function testdd() {
    console.log(document.querySelector('#scimg').toDataURL());
}
    function drawImage(){
    var ctx = $("canvas")[0].getContext("2d"),
        img = new Image();
    
    img.onload = function(){
        ctx.drawImage(img, 0, 0, 500, 500);
        $("span").text("Loaded.");
    };
    img.src = "http://photojournal.jpl.nasa.gov/jpeg/PIA17555.jpg";
    $("span").text("Loading...");
}


const {desktopCapturer, screen} = require('electron');

/**
 * Create a screenshot of the entire screen using the desktopCapturer module of Electron.
 *
 * @param callback {Function} callback receives as first parameter the base64 string of the image
 * @param imageFormat {String} Format of the image to generate ('image/jpeg' or 'image/png')
 **/
function fullscreenScreenshot(callback, imageFormat) {
    var _this = this;
    this.callback = callback;
    imageFormat = imageFormat || 'image/jpeg';
    
    this.handleStream = (stream) => {
        // Create hidden video tag
        var video = document.createElement('video');
        video.style.cssText = 'position:absolute;top:-10000px;left:-10000px;';
        // Event connected to stream
        video.onloadedmetadata = function () {
            // Set video ORIGINAL height (screenshot)
            video.style.height = this.videoHeight + 'px'; // videoHeight
            video.style.width = this.videoWidth + 'px'; // videoWidth

            // Create canvas
            var canvas = document.createElement('canvas');
            canvas.width = this.videoWidth;
            canvas.height = this.videoHeight;
            var ctx = canvas.getContext('2d');
            // Draw video on canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (_this.callback) {
                // Save screenshot to base64
                _this.callback(canvas.toDataURL(imageFormat));
            } else {
                console.log('Need callback!');
            }

            // Remove hidden video tag
            video.remove();
            try {
                // Destroy connect to stream
                stream.getTracks()[0].stop();
            } catch (e) {}
        }
        video.src = URL.createObjectURL(stream);
        document.body.appendChild(video);
    };

    this.handleError = function(e) {
        console.log(e);
    };

    // Filter only screen type
    desktopCapturer.getSources({types: ['screen']}, (error, sources) => {
        if (error) throw error;
        // console.log(sources);
        for (let i = 0; i < sources.length; ++i) {
            console.log(sources);
            // Filter: main screen
            if (sources[i].name === "Entire screen") {
                navigator.webkitGetUserMedia({
                    audio: false,
                    video: {
                        mandatory: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: sources[i].id,
                            minWidth: 600,
                            maxWidth: 800,
                            minHeight: 500,
                            maxHeight: 600
                        }
                    }
                }, this.handleStream, this.handleError);

                return;
            }
        }
    });
}
document.getElementById("trigger").addEventListener("click", function(){
                fullscreenScreenshot(function(base64data){
                    // Draw image in the img tag
                    $("#base64_img").val(base64data);
                    // call ajax request
                    var txt = $("#base64_img").val();
                    $.post("http://localhost:3000/api/opentrackpost", {image_post: txt}, function(result){
                        //alert(result);
                        //$("#base64_img").val('');
                    });

                    document.getElementById("my-preview").setAttribute("src", base64data);
                },'image/png');

                    
                
            },false);

//capture screenshot in time interval
setInterval(alertFunc, 7000);
function alertFunc(params) {
    $("#trigger").trigger("click");
}

</script>

</html>