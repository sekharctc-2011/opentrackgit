<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>My Electron Screenshot App</title>
        <style type="text/css">
            div.timer {
                border:1px #666666 solid;
                width:190px;
                height:50px;
                line-height:50px;
                font-size:36px;
                font-family:"Courier New", Courier, monospace;
                text-align:center;
                margin:5px;
            }
        </style>
    </head>
    <body>
         <div class="timer">
            <span class="hour">00</span>:<span class="minute">00</span>:<span class="second">00</span>
        </div>
        <div class="control">
            <input type="button" id="stime" value="Start" onClick="timer.start(1000)">
        </div>
        <p>Testing screenshots in Electron :3</p>
        <!-- <img id="my-preview"/> -->
        <!-- <label id="screenshot-path">Path :: </label> -->
        <!-- <input type="file" name="" value="upload file"> -->
        <!-- <button id="screen-shot">Take Screenshot</button> -->
        <!-- <input type="text" name="" value="" id="scid"> -->
        <!-- <button id="addimg">Add image</button><span></span> -->
        <!-- <canvas name="scimg" id="scimg" width="550" height="550"></canvas> -->

        <img id="my-preview"/>
        <input id="trigger" value="Fullscreen screenshot" type="button"/>
        <input type="text" id="base64_img" value="blah blah"/>

    </body>
    <script>
        
        let $ = require('jquery')
        // require('./render.js')

        var remote = require('electron').remote;
        document.addEventListener('keydown', function (e){
            if (e.which === 123) {
                remote.getCurrentWindow().webContents.openDevTools();
            } else if (e.which === 116){
                location.reload();
            }
        });

$("#addimg").click(testdd);
function testdd() {
    console.log(document.querySelector('#scimg').toDataURL());
}

function drawImage(){
    var ctx = $("canvas")[0].getContext("2d"),
        img = new Image();
    
    img.onload = function(){
        ctx.drawImage(img, 0, 0, 500, 500);
        $("span").text("Loaded.");
    };
    img.src = "http://photojournal.jpl.nasa.gov/jpeg/PIA17555.jpg";
    $("span").text("Loading...");
}


const {desktopCapturer, screen} = require('electron');

/**
 * Create a screenshot of the entire screen using the desktopCapturer module of Electron.
 *
 * @param callback {Function} callback receives as first parameter the base64 string of the image
 * @param imageFormat {String} Format of the image to generate ('image/jpeg' or 'image/png')
 **/
function fullscreenScreenshot(callback, imageFormat) {
    var _this = this;
    this.callback = callback;
    imageFormat = imageFormat || 'image/jpeg';
    
    this.handleStream = (stream) => {
        // Create hidden video tag
        var video = document.createElement('video');
        video.style.cssText = 'position:absolute;top:-10000px;left:-10000px;';
        // Event connected to stream
        video.onloadedmetadata = function () {
            // Set video ORIGINAL height (screenshot)
            video.style.height = this.videoHeight + 'px'; // videoHeight
            video.style.width = this.videoWidth + 'px'; // videoWidth

            // Create canvas
            var canvas = document.createElement('canvas');
            canvas.width = this.videoWidth;
            canvas.height = this.videoHeight;
            var ctx = canvas.getContext('2d');
            // Draw video on canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (_this.callback) {
                // Save screenshot to base64
                _this.callback(canvas.toDataURL(imageFormat));
            } else {
                console.log('Need callback!');
            }

            // Remove hidden video tag
            video.remove();
            try {
                // Destroy connect to stream
                stream.getTracks()[0].stop();
            } catch (e) {}
        }
        video.src = URL.createObjectURL(stream);
        document.body.appendChild(video);
    };

    this.handleError = function(e) {
        console.log(e);
    };

    // Filter only screen type
    desktopCapturer.getSources({types: ['screen']}, (error, sources) => {
        if (error) throw error;
        // console.log(sources);
        for (let i = 0; i < sources.length; ++i) {
            console.log(sources);
            // Filter: main screen
            if (sources[i].name === "Entire screen") {
                navigator.webkitGetUserMedia({
                    audio: false,
                    video: {
                        mandatory: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: sources[i].id,
                            minWidth: 600,
                            maxWidth: 800,
                            minHeight: 500,
                            maxHeight: 600
                        }
                    }
                }, this.handleStream, this.handleError);

                return;
            }
        }
    });
}

document.getElementById("trigger").addEventListener("click", function(){
                fullscreenScreenshot(function(base64data){
                    // Draw image in the img tag
                    $("#base64_img").val(base64data);
                    // call ajax request
                    var txt = $("#base64_img").val();
                    $.post("https://wepoptrack.herokuapp.com/api/opentrackpost", {image_post: txt}, function(result){
                        //alert(result);
                        //$("#base64_img").val('');
                    });

                    document.getElementById("my-preview").setAttribute("src", base64data);
                },'image/png');

                    
                
            },false);

//capture screenshot in time interval
//setInterval(TakeScreenShot, 60000);
function TakeScreenShot(params) {
    $("#trigger").trigger("click");
}

function _timer(callback)
{
    var time = 0;     //  The default time of the timer
    var mode = 1;     //    Mode: count up or count down
    var status = 0;    //    Status: timer is running or stoped
    var timer_id;    //    This is used by setInterval function
    var screen_take; //used for take/stop screenshot
    
    // this will start the timer ex. start the timer with 1 second interval timer.start(1000) 
    this.start = function(interval)
    {
        interval = (typeof(interval) !== 'undefined') ? interval : 1000;
 		
 		if(status == 1)
        {
            status = 0;
            clearInterval(timer_id);
            $("#stime").val('Start');
            clearInterval(screen_take);
        }
        else
        {
            if(status == 0)
            {
                // call screenshot function in interval
                screen_take = setInterval( function() { TakeScreenShot() }, 30000);
                // change start/pause button value
                $("#stime").val('Pause');
                status = 1;
                timer_id = setInterval(function()
                {
                    switch(mode)
                    {
                        default:
                        if(time)
                        {
                            time--;
                            generateTime();
                            if(typeof(callback) === 'function') callback(time);
                        }
                        break;
                        
                        case 1:
                        if(time < 86400)
                        {
                            time++;
                            generateTime();
                            if(typeof(callback) === 'function') callback(time);
                        }
                        break;
                    }
                }, interval);
            }
       }
    }
    
    //  Same as the name, this will stop or pause the timer ex. timer.stop()
    this.stop =  function()
    {
        if(status == 1)
        {
            status = 0;
            clearInterval(timer_id);
        }
    }
    
    // Reset the timer to zero or reset it to your own custom time ex. reset to zero second timer.reset(0)
    this.reset =  function(sec)
    {
        sec = (typeof(sec) !== 'undefined') ? sec : 0;
        time = sec;
        generateTime(time);
    }
    
    // Change the mode of the timer, count-up (1) or countdown (0)
    this.mode = function(tmode)
    {
        mode = tmode;
    }
    
    // This methode return the current value of the timer
    this.getTime = function()
    {
        return time;
    }
    
    // This methode return the current mode of the timer count-up (1) or countdown (0)
    this.getMode = function()
    {
        return mode;
    }
    
    // This methode return the status of the timer running (1) or stoped (1)
    this.getStatus
    {
        return status;
    }
    
    // This methode will render the time variable to hour:minute:second format
    function generateTime()
    {
        var second = time % 60;
        var minute = Math.floor(time / 60) % 60;
        var hour = Math.floor(time / 3600) % 60;
        
        second = (second < 10) ? '0'+second : second;
        minute = (minute < 10) ? '0'+minute : minute;
        hour = (hour < 10) ? '0'+hour : hour;
        
        $('div.timer span.second').html(second);
        $('div.timer span.minute').html(minute);
        $('div.timer span.hour').html(hour);
    }
}
 
// example use
var timer;
 
$(document).ready(function(e) 
{
    timer = new _timer
    (
        function(time)
        {
            if(time == 0)
            {
                timer.stop();
                alert('time out');
            }
        }
    );
    timer.reset(0);
    timer.mode(1);
});

</script>

</html>